# 🤖 Telegram Bot для управления заявками на переход границы

[![Python](https://img.shields.io/badge/Python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![Telegram Bot API](https://img.shields.io/badge/Telegram%20Bot%20API-Latest-green.svg)](https://core.telegram.org/bots/api)
[![MySQL](https://img.shields.io/badge/MySQL-8.0+-orange.svg)](https://www.mysql.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

## 📋 Описание

Этот Telegram бот предназначен для **управления заявками на переход границы** для пограничных служб. Система обеспечивает создание, отслеживание и обработку заявок с разграничением прав доступа для различных типов пользователей.

## ✨ Основные возможности

### 👥 Система ролей
- **👤 Обычный пользователь** - создание и отслеживание заявок
- **🛡️ Оператор** - обработка и управление заявками
- **👑 Администратор** - полный контроль системы

### 📝 Создание заявок
- **🧾 По образцу** - пошаговое заполнение полей
- **🗒 В свободной форме** - ввод всех данных одним сообщением
- **✏️ Редактирование** - возможность исправления ошибок

### 🔍 Управление заявками
- **📊 Просмотр** заявок по различным критериям
- **✅ Подтверждение/отмена** заявок
- **🔄 Дублирование** заявок для повторных операций
- **📈 Экспорт** данных в Excel

## 🏗️ Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram API  │    │   Python Bot    │    │   MySQL Database│
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │   Users     │◄────►│ │  Handlers   │◄────►│ │   users     │ │
│ │ (3 roles)   │ │    │ │             │ │    │ │  requests   │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  Messages   │◄────►│ │ Keyboards   │ │    │ │  Services   │ │
│ │ Callbacks   │ │    │ │             │ │    │ │  Logs       │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🚀 Быстрый старт

### 📋 Требования

- Python 3.9+
- MySQL 8.0+
- Telegram Bot Token

### 🔧 Установка

1. **Клонируйте репозиторий**
```bash
git clone <repository-url>
cd bot_cursor
```

2. **Установите зависимости**
```bash
pip install -r requirements.txt
```

3. **Настройте базу данных**
```sql
CREATE DATABASE telegram_bot;
CREATE USER 'bot_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON telegram_bot.* TO 'bot_user'@'localhost';
FLUSH PRIVILEGES;
```

4. **Создайте файл конфигурации**
```bash
# Создайте файл .env в корне проекта
TOKEN=your_telegram_bot_token
DB_HOST=localhost
DB_USER=bot_user
DB_PASSWORD=your_password
DB_NAME=telegram_bot
ADMIN_CHAT_ID=your_admin_chat_id
```

5. **Запустите бота**
```bash
python main.py
```

## 📁 Структура проекта

```
bot_cursor/
├── main.py                 # Главный файл запуска
├── config.py              # Конфигурация (токены, настройки БД)
├── db.py                  # Работа с базой данных
├── handlers/              # Обработчики команд и сообщений
│   ├── start.py          # Обработка команды /start
│   ├── new_request.py    # Создание новых заявок
│   ├── edit_request.py   # Редактирование заявок
│   ├── status.py         # Проверка статуса заявок
│   ├── admin/            # Функции администратора
│   │   ├── admin_commands.py
│   │   ├── admin_export.py
│   │   ├── admin_menu.py
│   │   ├── admin_requests.py
│   │   ├── admin_users.py
│   │   ├── conv_admin.py
│   │   └── states.py
│   └── operator/         # Функции оператора
│       └── operator_requests.py
├── keyboards/            # Клавиатуры и меню
│   ├── admin/
│   ├── operator/
│   ├── checkpoint.py
│   ├── dates.py
│   ├── direction.py
│   ├── main_menu.py
│   └── people_count.py
├── repositories/         # Слой доступа к данным
│   └── request_repo.py
├── services/             # Дополнительные сервисы
│   └── notifier.py
├── utils/                # Вспомогательные функции
│   ├── date_utils.py
│   ├── request_time.py
│   └── validators.py

```

## 🎯 Функциональность

### 📝 Создание заявки

#### По образцу
Пользователь проходит пошаговый процесс заполнения:

1. **🏢 Подразделение** - название подразделения
2. **🚧 Направление** - выбор направления перехода
3. **🚪 Пункт пропуска** - выбор конкретного КПП
4. **📅 Дата начала/окончания** - период операции
5. **⏰ Время начала/окончания** - временные рамки
6. **🚘 Марка авто** - транспортные средства
7. **👥 Количество людей** - число участников
8. **👨‍✈️ ФИО старшего** - ФИО старшего за рулем
9. **🔫 Наличие Груза** -Техника
10. **💬 Цель перехода** - цель перехода

#### В свободной форме
Пользователь вводит все данные одним сообщением:
```
🏢 Подразделение: Новый мир
🚧 Направление: Северное
🚪 Пункт пропуска: КПП-1
📅 Дата: 15.08 - 20.08
⏰ Время: 08:00 - 18:00
🚘 Марки авто и кол-во: КамАЗ-2, УАЗ-1
👥 Кол-во людей: 15
👨‍✈️ ФИО старшего: Орел-1
🔫 Наличие Груза: Паллеты, Персональные компьютеры
💬 Цель перехода: Перевозка груза
```

### 🔍 Просмотр заявок

#### Методы поиска
- **👤 По старшему** - поиск по позывному командира
- **📄 По номеру заявки** - прямой поиск по ID
- **📅 За сутки** - заявки за последние 2 дня и на 2 дня вперед

#### Действия с заявками
- **✅ Подтверждение** - одобрение заявки
- **❌ Отмена** - отклонение заявки
- **🔄 Дублирование** - создание копии заявки
- **❓ Запрос уточнений** - запрос дополнительной информации

### 👑 Администрирование

#### Управление пользователями
- **👀 Просмотр** всех пользователей
- **🔄 Изменение ролей** (user ↔ operator ↔ admin)
- **🚫 Блокировка/разблокировка** пользователей
- **🗑️ Удаление** пользователей

#### Экспорт данных
- **📊 За все время** - полная выгрузка
- **📊 За период** - выгрузка за указанный период
- **📊 Формат Excel** - структурированные данные

## 🗄️ База данных

### Таблица `users`
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,      -- ID пользователя в Telegram
    username VARCHAR(255),           -- Username пользователя
    full_name VARCHAR(255),          -- Полное имя
    role VARCHAR(32) DEFAULT 'user'  -- Роль: user/operator/admin
);
```

### Таблица `requests`
```sql
CREATE TABLE requests (
    id INT AUTO_INCREMENT PRIMARY KEY,  -- Уникальный ID заявки
    user_id BIGINT NOT NULL,           -- ID создателя заявки
    division VARCHAR(255),             -- Подразделение
    direction VARCHAR(50),             -- Направление
    checkpoint VARCHAR(100),           -- Пункт пропуска
    date_start VARCHAR(50),            -- Дата начала
    date_end VARCHAR(50),              -- Дата окончания
    time_start VARCHAR(5),             -- Время начала
    time_end VARCHAR(5),               -- Время окончания
    car_brand VARCHAR(255),            -- Марка авто
    people_count INT,                  -- Количество людей
    leader_name VARCHAR(255),          -- Позывной старшего
    cargo TEXT,                        -- Наличие ВВСТ
    purpose TEXT,                      -- Цель перехода
    status VARCHAR(32) DEFAULT 'Новая', -- Статус заявки
    edited_fields TEXT,                -- История изменений
    operator_id BIGINT,                -- ID оператора (если назначен)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Дата создания
);
```

### Статусы заявок
| Статус | Описание | Кто может изменить |
|--------|----------|-------------------|
| 🆕 **Новая** | Заявка только что создана | - |
| ⏳ **На рассмотрении** | Заявка отправлена на обработку | Оператор, Админ |
| ✅ **Подтверждена** | Заявка одобрена | Оператор, Админ |
| ❌ **Отклонена** | Заявка отклонена | Оператор, Админ |
| ❓ **Требует уточнений** | Нужны дополнительные данные | Только Админ |

## 🛡️ Безопасность

### Контроль доступа
- **Ролевая модель** - каждый пользователь имеет определенную роль
- **Проверка прав** - функции доступны только авторизованным пользователям
- **Блокировка** - администраторы могут блокировать проблемных пользователей

### Логирование
- **Подробные логи** - все действия пользователей записываются
- **Отслеживание изменений** - история изменений заявок
- **Аудит безопасности** - мониторинг подозрительной активности


## 📊 Мониторинг


### Команды администратора
- `/restart` - перезапуск бота
- `/hard_restart` - полный перезапуск
- `/broadcast` - отправка сообщения всем пользователям
- `/show_users` - просмотр всех пользователей
- `/refresh_operators` - обновление списка операторов

## 🔧 Конфигурация

### Переменные окружения
```bash
TOKEN=your_telegram_bot_token
DB_HOST=localhost
DB_USER=bot_user
DB_PASSWORD=your_password
DB_NAME=telegram_bot
ADMIN_CHAT_ID=your_admin_chat_id
```

### Настройки базы данных
```python
DB_CONFIG = {
    'host': 'localhost',
    'user': 'bot_user',
    'password': 'your_password',
    'database': 'telegram_bot',
    'charset': 'utf8mb4'
}
```

## 🚀 Развертывание

### Локальное развертывание
1. Установите зависимости
2. Настройте базу данных
3. Создайте файл `.env`
4. Запустите `python main.py`

### Docker развертывание
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["python", "main.py"]
```

### Системные требования
- **CPU**: 1 ядро
- **RAM**: 512 MB
- **Storage**: 1 GB
- **Network**: стабильное интернет-соединение

## 🤝 Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции
3. Внесите изменения
4. Добавьте тесты
5. Создайте Pull Request

## 📞 Поддержка

- **Issues**: Создавайте issues для багов и предложений
- **Discussions**: Обсуждения новых функций

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для получения дополнительной информации.

## 🙏 Благодарности

- [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot) - библиотека для работы с Telegram API
- [MySQL Connector/Python](https://dev.mysql.com/doc/connector-python/en/) - драйвер для работы с MySQL

---

**Версия**: 1.0  
**Дата последнего обновления**: Август 2025  
**Статус**: Готов к использованию
